name: Linux arm test

on:
  push:

# Due to a flutter bug, flutter build is not generating localizations
# workaround by always running flutter pub get immediately before building,
# and performing build for msix:create manually to allow implementing this workaround
jobs:

  upload-linux:
    name: Build and Upload Linux Assets
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libgtk-3-dev
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        id: flutter-version
        with:
          architecture: 'x64'
          channel: 'stable'
          dry-run: true
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          # Prebuilt ARM linux builds are not provided, so build flutter from source
          channel: master
          flutter-version: "${{ steps.flutter-version.outputs.VERSION }}"
      - run: flutter doctor
      - run: flutter pub get

      - name: Clone isar repository
        uses: actions/checkout@v4
        with:
          path: isar
          repository: Komodo5197/isar-community
          ref: f070a067378c215b9212a2a22ea593293671c9c9
      - name: Build isar core and inject into cached isar_flutter_libs
        run: |
          sh tool/build_linux.sh aarch64
          mv libisar_linux_aarch64.so $HOME/.pub-cache/git/isar_flutter_libs-59103190aa2ac03041d61ad6d127b540be079ec8/linux/libisar.so
        working-directory: isar

      - run: flutter build linux --release --no-pub
      # copy icon assets and desktop file next to bundle location for easy including in tar archive
      - run: |
          cp -r assets/icon/linux/ build/linux/arm64/release/icons \
          && cp assets/finamp.desktop.m4 build/linux/arm64/release/ \
          && cp assets/com.unicornsonlsd.finamp.metainfo.xml build/linux/arm64/release/
      # archive bundle and generate checksum
      - run: |
          tar -czf finamp-${{ github.ref_name }}-linux-arm-release.tar.gz --directory build/linux/arm64/release/ bundle icons finamp.desktop.m4 com.unicornsonlsd.finamp.metainfo.xml \
          && sha256sum finamp-${{ github.ref_name }}-linux-arm-release.tar.gz > finamp-${{ github.ref_name }}-linux-arm-release.tar.gz.sha256sum
      - uses: actions/upload-artifact@v4
        with:
          name: finamp-${{ github.ref_name }}-linux--arm-release.tar.gz
          path: finamp-${{ github.ref_name }}-linux-arm-release.tar.gz
          compression-level: 0 # no compression
      - uses: actions/upload-artifact@v4
        with:
          name: finamp-${{ github.ref_name }}-linux-arm-release.tar.gz.sha256sum
          path: finamp-${{ github.ref_name }}-linux--arm-release.tar.gz.sha256sum
          compression-level: 0 # no compression
  upload-windows:
    name: Build and Upload Windows Assets
    runs-on: windows-latest
    steps:
      - name: Support longpaths
        run: git config --system core.longpaths true
      - name: Clone repository
        uses: actions/checkout@v4
      # - uses: actions/setup-java@v2
      #   with:
      #     distribution: 'zulu'
      #     java-version: '17'
      - name: Set up Rust (for smtc_windows)
        uses: hecrj/setup-rust-action@v2
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: flutter doctor
      - run: flutter pub get
      - run: flutter build windows
      # copy vanilla build directory (for manual install)
      #TODO would be nice to have an old-school installer here that can take the .exe + libraries and install them to the device + create a shortcut
      # TODO pack in redistributables?
      - run: powershell Compress-Archive build/windows/x64/runner/Release/* ./Finamp-${{ github.ref_name }}-beta-Windows.zip
      - run: dart run msix:create --install-certificate false
      # copy msix file with correct naming
      - run: cp build/windows/x64/runner/Release/finamp.msix ./Finamp-${{ github.ref_name }}-beta-Windows.msix
      - uses: actions/upload-artifact@v4
        with:
          name: Finamp-${{ github.ref_name }}-beta-Windows.zip
          path: ./Finamp-${{ github.ref_name }}-beta-Windows.zip
      - uses: actions/upload-artifact@v4
        with:
          name: Finamp-${{ github.ref_name }}-beta-Windows.msix
          path: ./Finamp-${{ github.ref_name }}-beta-Windows.msix
          compression-level: 0 # no compression
